var AuthNativeDecryptView=BaseDecryptInputView.extend({initialize:function(options){this.options=$.extend({},this.defaults,options);$(this.el).show();AuthNativeDecryptView.__super__.finishInstructionText(this.options.json,this.options.authkey,$('#validLockifyAccount'));$('#authUis').addClass('auth_type_native');$('#methodMetaTips').remove();$('#nativeHeader').show();$('#emailInputLabel').text($('#emailInputLabel').data('default-text'));$('#loginButton_la').unbind('click');$('#loginButton_la').click(_.bind(this.handleLoginFormClick,this));this.bind('showSuccess',this.showSuccess);this.checkNativeUser(this.options.json);if($('#validLockifyAccount').children().hasClass('multipleValueIds')){$('#wrongAccount .single').hide();$('#wrongAccount .multiple').show();}
$('#back_native_button').hide();if(this.options.usernameReadOnly){$('#id_username_la').disable();$('#id_password_la').focus();}
$('#loginForgot').click(function(){$('.logregForm.pword-reset').show();$('.logregForm.login').hide();});$('.loginCancel').click(function(){$('.logregForm.pword-reset').hide();$('.logregForm.login').show();});$('.loginHelpLink').insertBefore('#password_errors').hide();$('.toggleMaskIcon').toggleMask({"inputs":$('#id_password_la')});},events:{"click #nativeBackButton":"handleBackClick"},showLoginWrongAccount:function(options){this.showLogin(options);$('#wrongAccount').removeClass('defaultHide');},showLoginDivForLogin:function(options){this.showLogin(options);},showLogin:function(options){$('#notYoursButtons').hide();$('#decryptLoginRequiredMessage').hide();$('#login_form_la').unbind('submit');$('#login_form_la').append($('<input type="hidden" name="dh" value="'+options+'"/>'));},showSuccess:function(){$('#loginDiv_la').hide();$('#notYoursButtons').show();$('#authNativeSuccessMsg').show();},handleLoginFormClick:function(){$('#id_username_la').prop('disabled',false);var login_element=$('#loginButton_la');login_element.find('.error').hide();var adhocForm=$('<form></form>');adhocForm.append($('#id_username_la').clone());adhocForm.append($('#id_password_la').clone());$('#login_form_la').find('input').removeClass('validationError');lockifyAjax.ajaxJSONSafeForm("/accounts/login_json/",adhocForm,this.handleNativeAuthSuccess,function(json){$('#loginButton_la').trigger('deanimate');$.each((json&&json.field_errors)||[],function(name,val){$('#'+name+"_errors_la").html(new Showdown.converter().makeHtml(val.join(' '))).show();$('#id_'+name+'_la').addClass('validationError');});});return false;},handleNativeAuthSuccess:function(json){$('#loginButton_la').trigger('deanimate');$('#loginDiv_la').hide();$('#notYoursButtons').show();$('#authNativeSuccessMsg').show();$('#back_native_button').hide();$('body').removeClass('guestUser');lockify.account.userInfo.set('csrf_token',json.csrf_token);new userDropdownView({el:$('#userDropdown'),model:null,username:json.username,uniqueurl:json.uniqueurl});$('.nonauthenticatedUserOnly').hide();$('.authenticatedUserOnly').show();},handleBackClick:function(){$('#authUi_lockifyUser').hide();$('#notYoursButtons').hide();$('#authUi_integratedemail').show();$('#emailMetaTips').show();$('#nativeHeader').hide();$('#emailHeader').show();},checkNativeUser:function(json){var self=this;if(json.is_native_user==null){$('#login_form_la').show();$('#confirmTrustBtn').click(function(){self.showLoginDivForLogin(encodeURIComponent(lockify.gateway.dataHash));});}else if(json.is_native_user===false){$('#login_form_la').show();$('#confirmTrustBtn').click(function(){self.showLoginWrongAccount(encodeURIComponent(lockify.gateway.dataHash));});}else{self.showSuccess();}}});