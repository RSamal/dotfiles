var BaseDecryptOutputView=Backbone.View.extend({initialize:function(){this.on('getSecretHandler',this.getSecretHandler);},events:{"click #getSecret":"getSecretHandler"},handleDownloadProgress:function(e){var p=Math.round((e.loaded/e.currentTarget.getResponseHeader('X-Content-Length-Unzipped')*1.0)*100);if(console){console.log("dl prog:"+p);}
$('#downloadMeter').progressbar({value:p});},getSecretHandler:function($this,event){var populateMessage=function(){lockify.gateway.fillWithText($('#dataShow'),$('#dataHide').val());if($("body").height()>$(window).height()){$("html, body").css('height','auto').animate({scrollTop:0},0);}else{$("html, body").animate({scrollTop:0},0);}};var self=this;$this.attr("disabled","disabled");$('#getSecret').unbind('click',this.getSecretHandler);var parentDiv=$this.parent().parent();if(parentDiv.find(".error:visible").length>0){parentDiv.find(".error:not(.authSuccess)").hide();}
var pword='';if(parentDiv.find("#decrypt_pword").length>0&&parentDiv.find("#decrypt_pword").val().length>0){pword=lockifyCryptoUtils.hash_sha256_b64u(lockify.gateway.salt+parentDiv.find("#decrypt_pword").val());}
var secAns=$.trim(parentDiv.find('#secAnswer').val());if(secAns.length>0){secAns=secAns.toLowerCase();if(lockify.gateway.linkAcceptsCloseAnswers&&secAns.replace(CLOSE_ANSWER_REGEX,'').length>=lockifyIndexGlobals.minCharsEnableClose){secAns=secAns.replace(CLOSE_ANSWER_REGEX,'');}
secAns=lockifyCryptoUtils.hash_sha256_b64u(lockify.gateway.salt+secAns);}
var otpCode='';if($('#voiceAuthMultiFactorCode').is(':visible')){otpCode=$('#voiceAuthMultiFactorCode').val();}else if($('#smsAuthMultiFactorCode').is(':visible')){otpCode=$('#smsAuthMultiFactorCode').val();}else if($('#emailAuthMultiFactorCode').is(':visible')){otpCode=$('#emailAuthMultiFactorCode').val();}
var data="dh="+encodeURIComponent(lockify.gateway.dataHash)+"&sa="+encodeURIComponent(secAns)+"&pword="+encodeURIComponent(pword)+"&twitter_auth_token="+encodeURIComponent($('#twitter_auth_token').val()||'')+"&openid_state="+encodeURIComponent(lockify.gateway.gOpenIDState||'')+"&otpCode="+otpCode;if($('#authMultiFactorSession').length&&$('#authMultiFactorSession').val()){data+="&sessionToken="+encodeURIComponent($('#authMultiFactorSession').val());}else if($('#authMultiFactorSessionEmail').length&&$('#authMultiFactorSessionEmail').val()){data+="&sessionToken="+encodeURIComponent($('#authMultiFactorSessionEmail').val());}
if(event!==undefined){if($(event.target).parent()[0]==$("#bypassLinkAuth")[0]){data+="&ownerBypass=1";}}
lockifyAjax.ajaxJSONSafe("/entry/get",data,function(json){var updateUIAfterHmacFailure=function(){$('#decryptionProgress').hide();$('#divHmacFailure').removeClass('defaultHide');};var updateUIAfterDecryptFailure=function(){$('#decryptionProgress').hide();$('#divFailure').removeClass('defaultHide');};var updateUIAfterDecrypt=function(){var fileCount=$("#saveDecFileContainer > #fileList > .fileRow").length;_showFileWarning=function(){if(fileCount>=1){$('#fileWarning').dialog(dialogOptions);if($("#dataHide").val().length){$('#withMessage').text($('#withMessage').data('messagetrue'));}else{$('#withMessage').text($('#withMessage').data('messagefalse'));}
if(fileCount>1){$('.withFileCount').text(fileCount+$('.withFileCount').data('multifile'));$('.withFile').text($('.withFile').data('multifile'));$('.withMultiFiles').removeClass('defaultHide');$('.expireFileNote').text($('.expireFileNote').data('multifile'));}else{$('.withFileCount').text($('.withFileCount').data('singlefile'));$('.withFile').text($('.withFile').data('singlefile'));$('.expireFileNote').text($('.expireFileNote').data('singlefile'));}}};_showFileWarning();if(Modernizr.cssanimations){$('#divGateway').one('webkitAnimationEnd mozAnimationEnd MSAnimationEnd oanimationend animationend',function(){$('#divGateway').hide();$('#decryptionProgress').hide();$('#divSuccess').removeClass('defaultHide').addClass('slideInRight');});}else{$('#divGateway').hide();$('#decryptionProgress').hide();$('#divSuccess').removeClass('defaultHide');}
if($('#divGateway').is(":hidden")){$('#decryptionProgress').hide();$('#divSuccess').removeClass('defaultHide').addClass('slideInRight');}
if($("#dataHide").val().length&&fileCount===0){$("#saveDecFileContainer").remove();$('#sensitivePayloadType').text("message's");$(".linkItemType").text("message");}
else if(!$("#dataHide").val().length&&fileCount!==0){$("#noFile, #decryptDataOverlayText, #dataShow, #dataBottomBar").remove();$("#saveDecFileContainer").addClass("fileOnlyContainer");$("#decryptDataContainer").find(".sectionSeparator").addClass('defaultHide');if(fileCount>1){$(".linkItemType").text("files");$('#sensitivePayloadType').text("files'");}else{$(".linkItemType").text("file");$('#sensitivePayloadType').text("file's");}}
else{$("#messageHeader, #fileIncluded").show();$("#noMessage").remove();$("#noFile").remove();$("#noFilePrint").show();$("#decryptDataContainer").addClass("withFiles");if(fileCount>1){$(".linkItemType").html("message &amp; files");$('#sensitivePayloadType').html("message &amp; files'");$(".printItemType").html("files");}else{$(".linkItemType").html("message &amp; file");$('#sensitivePayloadType').html("message &amp; file's");$(".printItemType").html("file");}}
var configExpire=new ConfigManualExpirationDecryptView({});configExpire.trigger('configExpirationMessage',json);$('#expireLimitsRefresh').click(function(){lockifyAjax.ajaxJSONSafe('/entry/expire_limits','dh='+encodeURIComponent(lockify.gateway.dataHash),function(json){configExpire.trigger('configExpirationMessage',json);},null);$("#valuesContainer").removeClass('hover').addClass('refresh');if(!lockifyUtils.isMobile){$("#expireLimitsRefresh").removeClass('hover').qtip('hide');}
setTimeout(function(){$("#valuesContainer").removeClass('refresh');},1000);});setTimeout(function(){lockifyUtils.cssFadeIn('.output-sec-bar');},200);if($('#gatewayConsole').length){$('#checkpointConsole').addClass('defaultHide');$('#decryptionConsole').removeClass('defaultHide');}
populateMessage();var configPrintingDecryptView=new ConfigPrintingDecryptView({});configPrintingDecryptView.trigger('configPrinting',json.prevent_message_printing);configExpire.trigger('configManualExpire',json.allow_manual_expiration,json.remaining_views,json.expire_auth_token);};if(json.status==='deleted'){lockifyUtils.showDeletedMessage(json);$('#expiredMessage p:first').show();return;}else if(json.status==='locked'){$("#onHoldDiv").show();$("#page").removeClass("withSidebar");$("#validDiv").hide();$("#onHoldDiv").find("#deletedItem").text(json.serverStoredAsset=="ciphertext"?"encrypted data":"decryption key");return;}else if(json.ratelimit_blocked){$(document).bind('ratelimitLockoutEnded',self.reenableButton);return;}
if(json.status==='answerWrong'||json.status==='passwordWrong'||json.status==='loginRequired'||json.status==='notAuthorized'||json.status==='codeWrong'||json.error){self.reenableButton();parentDiv.find(".error").show().html(new Showdown.converter().makeHtml(json.answerReply||json.error));parentDiv.find(".warning").show().text(json.warning);if(parentDiv.find('input').hasClass('toggleMaskInput')){parentDiv.find('input').parent().addClass('validationError');}else{parentDiv.find('input').addClass('validationError');}
if(json.status==='loginRequired'||json.status==='notAuthorized'){var loginLink=parentDiv.find('#nativeRelogin');loginLink.text((json.status==='loginRequired')?'Login now':'Login as different user');loginLink.show();$("#auth_native_error").show();}}else{if(json.bit_strength){new VerifiedUserView({el:$('#userWidget'),verifiedName:json.verifiedName,verifiedImage:json.verifiedImage,organizations:json.organizations});var messageBox=new MessageBoxView({el:$('#decryptDataContainer'),model:null,preventCopy:json.prevent_message_copying});var key,ciphertext;if(json.crypt_key===null){ciphertext=json.crypt_message;key=lockifyCryptoUtils.URLBase64ToBase64(lockify.gateway.crypt_str);}else{ciphertext=lockifyCryptoUtils.URLBase64ToBase64(lockify.gateway.crypt_str);key=json.crypt_key;}
if(ciphertext){var animElem=$('#divGateway');if(Modernizr.cssanimations){animElem.addClass('slideOutLeft');animElem.one('webkitAnimationEnd mozAnimationEnd MSAnimationEnd oanimationend animationend',function(){$('#divGateway').hide();$('#decryptionProgress').removeClass('defaultHide');});}else{$('#divGateway').hide();$('#decryptionProgress').removeClass('defaultHide');}
if(lockify.gateway.showDownloadProgress){$('#downloadProgress').show();$('#downloadMeter').progressbar({value:0});$(document).bind('dec-progress',function(e,val){$('#downloadMeter').progressbar({value:val});});}else{$('#confirmLoading').show();}
var hmacMatches=false;if(lockify.sjclBridge.decrypt.hasHmac(ciphertext)){hmacMatches=lockify.sjclBridge.decrypt.confirmHmac(key,ciphertext);ciphertext=ciphertext.substr(0,ciphertext.length-44);if(hmacMatches){$('.hmacResult .success').show();}else{$('.hmacResult .failed').show();var suppressDialog=true;Exception.handle("HMAC Verificaiton Failed -- Link Public ID: "+json.public_id,document.location.href,0,suppressDialog);updateUIAfterHmacFailure();return;}}else{var suppressDialog=true;Exception.handle("HMAC Missing -- Link Public ID: "+json.public_id,document.location.href,0,suppressDialog);}
try{lockify.sjclBridge.decrypt.decryptData(key,json.bit_strength,ciphertext,function(message,filelist){$("#dataHide").val(message);if(filelist.length){lockify.gateway.fileDecryptView=new FileDecryptView({supportsDownloadAttribute:lockify.gateway.supportsDownloadAttribute,FlashFileDownloads:[]});lockify.gateway.fileDecryptView.trigger('displayFilesToSave',filelist,updateUIAfterDecrypt);}else{updateUIAfterDecrypt();}
populateMessage();});}catch(error){updateUIAfterDecryptFailure();Exception.handle("Decryption error occurred",'','',true,false);}}else{updateUIAfterDecrypt();}}}
return;},function(XMLHttpRequest,textStatus,errorThrown){$("#getSecret").trigger("deanimate");$("#divGateway").append(XMLHttpRequest.responseText);},120000,null,null,(lockify.gateway.showDownloadProgress&&(!$.browser['msie']||parseFloat($.browser.version)>10.0))?function(){var req=$.ajaxSettings.xhr();req.addEventListener('progress',this.handleDownloadProgress);return req;}:null);},reenableButton:function(){$("#getSecret").trigger("deanimate");$("#getSecret").removeAttr("disabled");$("#divGateway").show();}});