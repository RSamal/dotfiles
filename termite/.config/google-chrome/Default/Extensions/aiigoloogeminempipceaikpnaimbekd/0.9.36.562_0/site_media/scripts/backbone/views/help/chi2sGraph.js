var Chi2sGraphView=Backbone.View.extend({defaults:{height:200,rightMargin:55,refPercentages:[100,50,10,2],barWidth:2,barSpace:1,leftBarMargin:20},initialize:function(options){this.options=$.extend({},this.defaults,options||{});_.bindAll(this,'drawChiBar');this.model.bind('change:chi2s',this.drawChiBar);_.bindAll(this,'handleSampleSizeSet');$(document).bind('sampleSizeSet',this.handleSampleSizeSet);_.bindAll(this,'handleAllRunsComplete');$(document).bind('randomGridComplete',this.handleAllRunsComplete);},render:function(){this.$('canvas').remove();this.$('#chi2sRaw').children().remove();chiCanvas=document.createElement('canvas');chiCanvas.width=this.options.width;chiCanvas.height=this.options.height;this.$('#chi2sRaw').after(chiCanvas);chiCtx=chiCanvas.getContext('2d');chiCtx.fillStyle="transparent";chiCtx.fillRect(0,0,chiCanvas.width-this.options.rightMargin,chiCanvas.height);this.drawRefLines(this.options.refPercentages);this.drawYAxisLabel();return this;},handleSampleSizeSet:function(e,intCount){this.$('.byteCount').text(lockifyUtils.numberWithCommas(intCount*4));},drawRefLines:function(percentages){var self=this;$.each(percentages,function(i,value){var logPercent=(Math.log(value+2)/Math.log(100+2));var lineHeight=chiCanvas.height-Math.round(chiCanvas.height*logPercent);chiCtx.fillStyle="#3F3F3F";chiCtx.fillRect(0,lineHeight,chiCanvas.width-self.options.rightMargin,1);chiCtx.fillStyle="#3F3F3F";chiCtx.lineStyle="#000000";chiCtx.font="12px sans-serif";chiCtx.fillText(value+"%",chiCanvas.width-self.options.rightMargin+4,lineHeight+10);});chiCtx.fillRect(0,chiCanvas.height-1,chiCanvas.width-self.options.rightMargin,1);},drawYAxisLabel:function(){chiCtx.save();chiCtx.rotate(-Math.PI/2);chiCtx.textAlign="center";chiCtx.fillText("Log (X2 prob. of good randomness)",-chiCanvas.height/2,chiCanvas.width-3);chiCtx.restore();},drawChiBar:function(event,fillStyle){if(typeof fillStyle=='undefined'){chiCtx.fillStyle="#1C3B67";}
var i=this.model.get('chi2s').length-1;var chi2Percent=this.model.getFormattedValForIndex(i,1);this.$('.currentRun').text(i+1);this.$('.currentVal').text(chi2Percent);var row=$('<div>');row.append($('<span>').text("Run "+(i+1)+": "));row.append($('<span></span>').text(chi2Percent));this.$('#chi2sRaw').prepend(row);this.$('#chi2sAvg').text(this.model.getFormattedAvgUpToIndex(i,1));var logPercent=this.model.getLogValForIndex(i,1);chiCtx.fillRect((this.options.barWidth+this.options.barSpace)*i+this.options.leftBarMargin,chiCanvas.height-Math.round(chiCanvas.height*logPercent),this.options.barWidth,Math.round(chiCanvas.height*logPercent));},handleAllRunsComplete:function(){$('body').focus();}});