var CameraCaptureView=Backbone.View.extend({defaults:{CAMERA_PHOTO_NAME_PAT:/lockify_camera_photo_([0-9]{2}).png/},events:{},initialize:function(options){this.options=$.extend({},this.defaults,options||{});$('video').eq(0).show();$('#cameraError').hide();var self=this;_.bindAll(this,['getGreatestFileNum']);navigator.webkitGetUserMedia({audio:false,video:true},function(stream){$('#cameraLoading').removeClass('defaultHide');$('#cameraOverlay').addClass('videoOn');$('#capture, #cancel, #rejectCapture, #acceptCapture').unbind('click');document.querySelector('video').src=webkitURL.createObjectURL(stream);$('#capture').removeClass('defaultHide');$('#cancel').removeClass('defaultHide');$('#capture').click(function(e){$('#cameraFlash').removeClass('defaultHide');setTimeout(function(){$('#cameraFlash').addClass('defaultHide');},150);$('video')[0].pause();$('#cameraButtons').addClass('defaultHide');$('#photoButtons').removeClass('defaultHide');});$('#rejectCapture').click(function(e){$('video')[0].play();$('#cameraButtons').removeClass('defaultHide');$('#photoButtons').addClass('defaultHide');});$('#acceptCapture').click(function(e){var vid=$('video')[0];var canvas=document.createElement('canvas');canvas.width=$('video').eq(0).width();canvas.height=$('video').eq(0).height();var ctx=canvas.getContext('2d');ctx.drawImage($('video')[0],0,0,canvas.width,canvas.height);stream.stop();var fff=lockifyCryptoUtils.dataURLToBlob(canvas.toDataURL());var curGreatest=self.getGreatestFileNum();var pad="00";curGreatest++;var newNum=(pad+curGreatest).slice(-pad.length);fff.name=self.options.CAMERA_PHOTO_NAME_PAT.source.replace(/\(.*\)/,newNum);uiFileReader.commonHandleChange([fff]);$('#cameraButtons').removeClass('defaultHide');$('#photoButtons').addClass('defaultHide');$('#cameraOverlay').addClass('defaultHide');});$('#cancel').click(function(){$('#cameraOverlay').addClass('defaultHide');});},function(e){$('#closeError').click(function(){$('#cameraOverlay').addClass('defaultHide');});$('video').hide();$('#capture').addClass('defaultHide');$('#cancel').addClass('defaultHide');$('#cameraLoading').addClass('defaultHide');$('#cameraError').show();console.error(e);});},getGreatestFileNum:function(){var ret=0;var filenames=lockify.index.entry.filenames().split('|');var self=this;$.each(filenames,function(i,n){var mm=n.match(self.options.CAMERA_PHOTO_NAME_PAT);if(mm){var num=parseInt(mm[1],10);if(num>ret){ret=num;}}});return ret;}});