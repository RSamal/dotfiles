var uiFileReader=null;var fileListView=null;function showNoFlashMsg(){$('#noFlashPluginMsg').show();$('#wrongFlashPluginVersionMsg').hide();$("#loadFileReader").hide();}
function showWrongFlashVersionMsg(){$('#detectedFlashVersion').text(swfobject.ua.pv.slice(0,2).join('.'));$('#wrongFlashPluginVersionMsg').show();$('#noFlashPluginMsg').hide();$("#loadFileReader").hide();}
if(lockifyUtils.isHtml5Enabled()||lockifyUtils.isFlashInstalled()){$(document).bind('formBoundToUserPrefs',function(){if($('#addFileDisabled').is(':visible')){return;}
var fileCol=new FileCollection();fileListView=new FileListView({el:"#addedDocsDiv",collection:fileCol});var saveFileMetadataView=new SaveFileMetadataView({el:".saveFileMetadataContainer",collection:fileCol});saveFileMetadataView.listenTo(fileListView,'listUpdated',saveFileMetadataView.updateLabelText);var fileReaderOptions={collection:fileCol,listView:fileListView,maxFileKb:$("#incFileToggle").data("maxKb")};$('#divInput').addClass('withFiles');if((lockifyIndexGlobals.defaultFileReader=='html5'||lockifyIndexGlobals.defaultFileReader=='best')&&lockifyUtils.isHtml5Enabled()){$.extend(fileReaderOptions,{el:"#html5FileReader",enableDnD:$('#dragTarget').length>0});uiFileReader=new Html5FileReaderView(fileReaderOptions);$('#reqFlashVer').hide();$('#flashFileReader').remove();$('#noFlashPluginMsg').remove();$('#wrongFlashPluginVersionMsg').remove();uiFileReader.updateAvailableFileUnits();}else{$("#html5FileReader").remove();$("#dragTarget").remove();$("#html5dragBorder").remove();$.extend(fileReaderOptions,{el:"#incFileToggle",autoloadReader:lockifyIndexGlobals.autoloadFileReader,varName:'uiFileReader'});uiFileReader=new FlashFileReaderView(fileReaderOptions);}
lockify.index.entry.gatherFileMetadata=uiFileReader.gatherFileMetadata;lockify.index.entry.gatherFiles=uiFileReader.gatherFiles;lockify.index.entry.fileCollection=uiFileReader.collection;if(typeof FlashFileReaderView!='undefined'&&uiFileReader instanceof FlashFileReaderView){if(!swfobject.hasFlashPlayerVersion('0.0.1')){showNoFlashMsg();$('#flashFileReader').remove();return;}else if(!swfobject.hasFlashPlayerVersion(lockifyIndexGlobals.minFlashReaderVersion)){showWrongFlashVersionMsg();$('#flashFileReader').remove();return;}else{$('#noFlashPluginMsg').remove();$('#wrongFlashPluginVersionMsg').remove();}}});}else{$('#incFileToggle').parent().remove();}
var removeAllFiles=function(){$("div.fileRow, div.fileSumRow").slideUp(1000,function(){$(this).remove();});if(typeof fileReader==="function"&&fileReader()){fileReader().clearFileRefs();fileReader().enableButton();}
uiFileReader.updateAvailableFileUnits();$('#incFileIcon').show();$(document).trigger('fileRemoved');};var fileLinkFocusHandler=function(){$(this).addClass('fileLinkCell-hover');};var fileLinkBlurHandler=function(){$(this).removeClass('fileLinkCell-hover');};var fileLinkKeyupHandler=function(event){if(event.keyCode==13||event.keyCode==32){$(this).click();}};function flashOnReadyHandler(){$('#reqFlashVer').hide();uiFileReader.updateAvailableFileUnits();}
function getCipherFile(){return cipherFiles[0].cipherStr;}
function flashBlurHandler(shiftKey){if(shiftKey){$("#data").focus();}else{if($(".fileLinkCell").length){$(".fileLinkCell").eq(0).focus();}else if($(".authOptionPanel:visible").length){$(".authOptionPanel:visible:first .authPanelback").focus();}else{$(".authOption_link").eq(0).focus();}}}
function modifyInputDescription(){var inputDesc=$(this).text();var fileCount=lockify.index.entry.get('files').length;if(inputDesc=="message was "&&fileCount>0){inputDesc="message ";if(fileCount>1){inputDesc+="and files were ";}else if(fileCount==1){inputDesc+="and file were ";}}else if(inputDesc===""){if(fileCount>1){inputDesc="files were ";}else if(fileCount==1){inputDesc="file was ";}}
$(this).text(inputDesc);}
$(document).ready(function(){$(document).bind('formReset',removeAllFiles);$('#console_inputDesc').bind('change',modifyInputDescription);$(document).on("mouseover",".fileLinkCell",function(){$(this).parent('.fileRow').addClass('hover');}).on("mouseout",".fileLinkCell",function(){$(this).parent('.fileRow').removeClass('hover');});});function getMaxFileKb(){return uiFileReader.options.maxFileKb;}