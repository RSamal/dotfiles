var OrganizationView=Backbone.View.extend({events:{"mouseenter #orgLogoBlock":'switchChangeBlock',"mouseleave #orgLogoBlock":'switchImageBlock',"click #orgLogoRemoveLink":'removeLink',"click #orgLogoAddLink":'forceClickUploadInput',"click #orgLogoChangeLink":'forceClickUploadInput',"submit #formLogoUpload":'formSubmit',"change #orgLogoUploadInput":"inputChanged","click #editTimezoneLink":"editTimeZoneDialog","click #setTimezoneBtn":"editTimeZoneSubmit"},initialize:function(options){this.options=$.extend({},this.defaults,options);this.logoImageBlock=this.$('#orgLogoImageBlock');this.logoAddBlock=this.$('#orgLogoAddBlock');this.logoChangeBlock=this.$('#orgLogoChangeBlock');this.changeTzDialog=this.$("#changeTzDialog");this.orgTimezone=this.$('#orgTimezone');_.bindAll(this,['handleChange']);_.bindAll(this,['logoUploaded']);this.model.bind('change',this.handleChange);this.model.fetch().done(_.bind(this.handleFetchSuccess,this));},handleFetchSuccess:function(){this.tzDropDown=new TimezoneSelectView({el:this.$('#orgTimezoneSelect .timezoneViewWrapper'),model:this.model.set('timezone',this.model.get('organization').timezone)});},switchChangeBlock:function(e){if(this.logo){this.logoImageBlock.hide();this.logoChangeBlock.show();}},switchImageBlock:function(e){if(this.logo){this.logoImageBlock.show();this.logoChangeBlock.hide();}},removeLink:function(e){var url="/sme/organization/api/remove_logo/"+this.model.get('id');var view=this;$.get(url,function(data){if(data=='removed'){view.clearLogoImage();view.logoImageBlock.hide();view.logoChangeBlock.hide();view.logoAddBlock.show();}});return false;},forceClickUploadInput:function(){this.$('#orgLogoUploadInput').trigger('click');return false;},clearLogoImage:function(){this.logo='';this.updateLogoImage();},updateLogoImage:function(){var logo_url=this.logo+"?"+new Date().getTime();if(typeof(document.ajax_domain)!=='undefined'){if(logo_url.indexOf('http')!=0){logo_url=document.ajax_domain+logo_url;var self=this;var loadImage=function(uri){var xhr=new XMLHttpRequest();xhr.responseType='blob';xhr.onload=function(){var data=window.URL.createObjectURL(xhr.response);self.$('#orgLogoImage').attr('src',data);};xhr.open('GET',uri,true);xhr.send();};loadImage(logo_url);return;}}
this.$('#orgLogoImage').attr('src',logo_url);},logoUploaded:function(data){this.logo=data;this.updateLogoImage();this.logoAddBlock.hide();this.logoChangeBlock.hide();this.logoImageBlock.show();},formSubmit:function(){var obj=this.$('#formLogoUpload');var formData=new FormData(obj[0]);var view=this;$.ajax({url:"/sme/organization/api/set_logo/",type:'POST',data:formData,success:view.logoUploaded,cache:false,contentType:false,processData:false});return false;},inputChanged:function(event){if(event.currentTarget.files.length==0){return;}
if($.inArray(event.currentTarget.files[0].type,event.currentTarget.accept.split(','))==-1){$("#wrongFileTypeDialog").dialog(dialogOptions);return;}
this.$('#formLogoUpload').submit();},handleChange:function(model){this.$('#id_slug').val(model.get('id'));this.$('.orgSlug span').text(model.get('organization').name);var role=model.get('membership').role;var roleDisplay=role.charAt(0).toUpperCase()+role.slice(1);this.$('#membershipRole').text(roleDisplay);this.orgTimezone.text(model.get('organization').timezone_desc);this.orgTimezone.data('timezone',model.get('organization').timezone);this.$('#orgCurrentMemberCount').text(model.get('current_member_count'));this.$('#orgMaxMemberCount').text(model.get('max_member_count'));this.logo=model.get('organization').logo;if(this.logo){this.updateLogoImage();this.logoImageBlock.show();}
else{this.logoAddBlock.show();}},editTimeZoneDialog:function(){this.changeTzDialog.dialog(dialogOptions);this.tzDropDown.setSelectedValue(this.orgTimezone.data('timezone').replace(/ /g,'_'));},editTimeZoneSubmit:function(){var selectedOption=this.tzDropDown.getSelectedOption();var organization=this.model.get('organization');organization.timezone=selectedOption.data('value');organization.timezone_desc=selectedOption.text();this.model.save().done(_.bind(this.handleTimezoneSaveSuccess,this));},handleTimezoneSaveSuccess:function(){try{this.changeTzDialog.dialog('close');}catch(x){}
var view=this;this.changeTzDialog.bind('dialogclose',function(event){$("#successChangeTz").dialog($.extend({},dialogOptions,{modal:false,dialogClass:"blip"}));setTimeout(function(){try{$("#successChangeTz").dialog('close');}catch(x){}
view.changeTzDialog.unbind('dialogclose');},2500);});}});