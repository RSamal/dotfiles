var MemberFormView=Backbone.View.extend({events:{},initialize:function(options){this.options=$.extend({},this.defaults,options||{});_.bindAll(this,'handleAddBtnClick','handleEditBtnClick','handleSaveSuccess','handleSaveFail','updateTimezone','render');this.$('button').unbind('click').waitButton();this.roleDropdown=this.$('#roleDropdown').imageDropdown({'selectList':this.$("#roleDropdown").parent().find('.customSelectList'),'highlightClass':'li-hover'});this.timezoneSelect=new TimezoneSelectView({el:this.$('.timezoneViewWrapper'),model:this.model,allTimezones:this.options.allTimezones,favoredTimezones:this.options.favoredTimezones});this.listenTo(this.model,"change:timezone",this.updateTimezone);this.render();this.updateTimezone();},render:function(){this.roleDropdown.setSelectedValue(this.model.get('role')).close();this.$('.roleRowReadOnly span').text(this.model.get('roleDisplay'));this.$('#smeMemberFirstName').val(this.model.get('first_name'));this.$('#smeMemberLastName').val(this.model.get('last_name'));this.$('#smeMemberEmail').val(this.model.get('email'));this.$('button').unbind('click',this.handleAddBtnClick);this.$('button').unbind('click',this.handleEditBtnClick);if(this.model.isNew()){this.configFormForAdd();this.$('button').bind('click',this.handleAddBtnClick);}else{this.configFormForEdit();this.model.fetch();this.$('button').bind('click',this.handleEditBtnClick);}
this.disableFieldsByEditorRoleAndStatus();return this;},configFormForAdd:function(){this.$('.dialogHeader .defaultText').text('Add new member');this.$('button[data-action="addOrEdit"]').text('Add');this.$('button[data-action="addAndInvite"]').show();return this;},configFormForEdit:function(){this.$('.dialogHeader .defaultText').text('Edit membership');this.$('button[data-action=addOrEdit]').text('Update member info');this.$('button[data-action=addAndInvite]').hide();return this;},disableFieldsByEditorRoleAndStatus:function(){try{if(this.model.orgModel.get('membership').role=="owner"){this.enableRoleUi();}else{this.disableRoleUi();}}catch(e){this.disableRoleUi();}
if(this.model.get('role')=='owner'){this.disableRoleUi();}
var fields=this.$('#smeMemberEmail');if(this.model.get('status')=='active'){fields.attr('disabled','disabled');this.disableTimezoneUi();}else{fields.attr('disabled',null);this.enableTimezoneUi();}},disableFieldsByStatus:function(){},enableRoleUi:function(){this.$('.roleRowReadOnly').hide();this.$('.roleRowEdit').show();},disableRoleUi:function(){this.$('.roleRowReadOnly').show();this.$('.roleRowEdit').hide();},enableTimezoneUi:function(){this.$('.timezoneRowReadOnly').hide();this.$('.timezoneRowEdit').show();},disableTimezoneUi:function(){this.$('.timezoneRowReadOnly').show();this.$('.timezoneRowEdit').hide();},updateTimezone:function(){this.timezoneSelect.setSelectedValue(this.model.get('timezone'));this.$('.timezoneTarget').text(this.model.get('timezone_desc'));this.$('.timezoneLoading').hide();},handleAddBtnClick:function(e){this.$('.formError').hide();var isInviteRequested=$(e.target).data('action')=="addAndInvite";this.model.set('isInviteRequested',isInviteRequested);this.model.set({"first_name":this.$('#smeMemberFirstName').val(),"last_name":this.$('#smeMemberLastName').val(),"email":this.$('#smeMemberEmail').val(),"roleDisplay":this.roleDropdown.val(),"timezone":this.timezoneSelect.val()}).save({wait:true}).done(this.handleSaveSuccess).fail(this.handleSaveFail);},handleEditBtnClick:function(e){this.$('.formError').hide();this.model.set({"first_name":this.$('#smeMemberFirstName').val(),"last_name":this.$('#smeMemberLastName').val(),"email":this.$('#smeMemberEmail').val(),"roleDisplay":this.roleDropdown.val(),"timezone":this.timezoneSelect.val()}).save(_.extend(_.pick(this.model.attributes,'first_name','last_name','email','role','timezone'),{wait:true}),{patch:true}).done(this.handleSaveSuccess).fail(this.handleSaveFail);},handleSaveSuccess:function(){this.trigger('memberAdded',this.model);this.trigger('change:first_name');this.trigger('change:last_name');},handleSaveFail:function(){this.$('button').trigger('deanimate');if(this.model.validationError){this.$('.formError').text(this.model.validationError.formError).show().removeClass('defaultHide');var self=this;$.each(this.model.validationError.fieldErrors,function(i,fieldError){var capFieldName=fieldError.fieldName.charAt(0).toUpperCase()+fieldError.fieldName.slice(1);self.$('#smeMember'+capFieldName+"_errors").text(fieldError.error).show();self.$('#smeMember'+capFieldName).addClass('validationError');});}}});