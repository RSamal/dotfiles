var GeneralSettingsView=Backbone.View.extend({events:{"change #startScreen":"handleStartScreenChange","click #deleteAccount":"handleDeleteAccount","click #deleteAccountBtn":"handleAcctDeleteBtnClick","click #changeEmailBtn":"handleEmailChange","click #changePasswordBtn":"handlePswdChangeClick"},initialize:function(){$('#savePasswordButton').waitButton();$('#saveEmailButton').waitButton();var emailChangeDialog=$('#emailChangeDialog');emailChangeDialog.find('.toggleMaskIcon').toggleMask({"inputs":emailChangeDialog.find('#id_password')});var passwordChangeDialog=$('#passwordChangeDialog');$('#currentPassToggle').toggleMask({"inputs":passwordChangeDialog.find('#id_old_password')});$('#newPassToggle').toggleMask({"inputs":passwordChangeDialog.find('#id_new_password1, #id_new_password2')});$('#usernameDisplay').text(this.model.get('username'));$('#emailDisplay').text(this.model.get('emailAddress'));_.bindAll(this,['handleEmailLeakOff']);$('#turnEmailLeakOff').click(this.handleEmailLeakOff);_.bindAll(this,['handleEmailLeakOn']);$('#turnEmailLeakOn').click(this.handleEmailLeakOn);this.tzoneDropDown=new TimezoneSelectView({el:$('.timezoneViewWrapper'),model:this.model});_.bindAll(this,['handleTzChange']);this.tzoneDropDown.bind('change',this.handleTzChange);this.startScreenDropDown=$('#startScreenSelect').imageDropdown({'selectList':$("#startScreenSelect_options"),'initialValue':this.model.get('startUrlName'),'highlightClass':'li-hover'});_.bindAll(this,['handleStartScreenChange']);this.startScreenDropDown.bind('change',this.handleStartScreenChange);$('#deleteAccountBtn').bind('click',this.handleAcctDeleteBtnClick);_.bindAll(this,['handleEmailSaveClick']);$('#id_email, #id_email_confirm').bind('paste',this.handleEmailPaste);$('#saveEmailButton').bind('click',this.handleEmailSaveClick);$('#emailChangeForm').bind('submit',this.handleEmailSubmit);$('#savePasswordButton').bind('click',this.handlePasswordClick);$('#passwordChangeForm').bind('submit',this.handlePasswordSubmit);$('#id_new_password2').bind('keyup',this.handlePasswordMatchTest);$("#closeLeakDialog").bind('click',this.handleEmailLeakClose);$("#emailLeakOff .link").bind('click',this.handleEmailLeakOpen);if(!this.model.get('leakEmail')){$('#emailLeakOn').show();$('#emailLeakOff').hide();}else{$('#emailLeakOff').show();$('#emailLeakOn').hide();}},handleStartScreenChange:function(event){var elem=$(event.target);this.model.save({startUrlName:this.startScreenDropDown.val()},{success:function(){lockifyUtils.displayUpdateResultDialog(lockifyGlobals.savedMsg);},error:function(){lockifyUtils.displayUpdateResultDialog('Something went wrong. Please try again.');}});},handleEmailLeakOff:function(event){this.model.save({leakEmail:false},{success:function(){$('#emailLeakOff').hide();$('#emailLeakOn').show();$('#emailLeakDialog').dialog('close');},error:function(){}});},handleEmailLeakOn:function(event){this.model.save({leakEmail:true},{success:function(){$('#emailLeakOn').hide();$('#emailLeakOff').show();$('#emailLeakDialog').dialog('close');},error:function(){}});},handleDeleteAccount:function(){$("#deleteAccountDialog").dialog(dialogOptions);$("button").blur();},handleAcctDeleteBtnClick:function(){$("#confirmAccountDelete").hide();$("#emailAccountDelete").show();$("#deleteAccountDialog .dialogFooter").children().hide();$('#deleteAccountDialog .dialogFooter').addClass('collapse');$("#deleteAccountDialog #confirmHeader").hide();$("#deleteAccountDialog #emailHeader").show();},handleEmailChange:function(){$('#emailChangeDialog .dialogFooter').children().show();$('#emailChangeForm .error').hide();$('#emailChangeForm').show();$("#emailChangeDialog").dialog($.extend({},dialogOptions,{close:function(){$('#emailChangeDialog .dialogFooter').children().show();$('#emailChangeForm .error').hide();$('#emailChangeForm').show();$('#emailChangeForm')[0].reset();}}));},handleEmailPaste:function(e){e.preventDefault();return false;},handleEmailSaveClick:function(){var abort=false;if(!lockifyUtils.isEmail($('#id_email').val())){$('#email_errors').text('Email not in valid format, e.g. you@domain.com.').show();abort=true;}
if(!lockifyUtils.isEmail($('#id_email_confirm').val())){$('#email_confirm_errors').text('Email not in valid format, e.g. you@domain.com.').show();abort=true;}
if(abort){return false;}else{$('#emailChangeForm').submit();}},handleEmailSubmit:function(){$('#emailChangeForm').find('input').removeClass('validationError');lockifyAjax.ajaxJSONSafeForm('/account/email/change',$(this),function(json){$('#emailChangeDialog').dialog('close');$('#page .column').hide();$('.authenticatedUserOnly').hide();$('.nonauthenticatedUserOnly').show();$('#emailSuccess .oldEmail').text(json.oldEmail);$('#emailSuccess .newEmail').text(json.newEmail);$('#emailSuccess').show();$('.sidebar').hide();$('body').removeClass('withNavBar').addClass('guestUser');},function(json){$('#emailSuccess').hide();$('#emailChangeForm').show();$('#emailChangeDialog .dialogFooter').children().show();$('#emailChangeDialog .dialogFooter').removeClass('collapse');$('#emailChangeForm .error').hide();if(json.errors){$.each(json.errors,function(name,val){$('#'+name+"_errors").text(val.join(' ')).show();if($('#id_'+name).hasClass('toggleMaskInput')){$('#id_'+name).parent().addClass('validationError');}else{$('#id_'+name).addClass('validationError');}});}
if(!json.logged_in){$('#saveEmailButton').addClass('disabled').prop('disabled',true).unbind('click');$('#emailChangeForm').unbind('submit');$("#emailChangeDialog").bind('dialogclose',function(event,ui){document.location.href='/';});}});return false;},handlePswdChangeClick:function(){$("#passwordChangeDialog").dialog($.extend({},dialogOptions,{close:function(){$('#passwordChangeForm .error').hide();$('#passwordChangeForm')[0].reset();$("#pwordStrength").children().hide();$("#noMatchMessage,#partialMatchMessage,#totalMatchMessage").hide();}}));},handlePasswordClick:function(){$('#passwordChangeForm').submit();},handlePasswordSubmit:function(){$('#passwordChangeDialog').find('input').removeClass('validationError');lockifyAjax.ajaxJSONSafeForm('/account/password/change',$(this),function(json){$("#successPwordChange").dialog($.extend({},dialogOptions,{modal:false,dialogClass:"blip",open:function(event,ui){setTimeout(function(){$('#successPwordChange').dialog('close');},5000);}}));},function(json){$('#passwordChangeForm .error').hide();if(json.errors){$.each(json.errors,function(name,val){$('#'+name+"_errors").text(val.join(' ')).show();if($('#id_'+name).hasClass('toggleMaskInput')){$('#id_'+name).parent().addClass('validationError');}else{$('#id_'+name).addClass('validationError');}});}
if(!json.logged_in){$('#savePasswordButton').addClass('disabled').prop('disabled',true).unbind('click');$('#passwordChangeForm').unbind('submit');$("#passwordChangeDialog").bind('dialogclose',function(event,ui){document.location.href='/';});}});return false;},handlePasswordMatchTest:function(){if(typeof $.fn.complexityGauge==="function"){$('#id_new_password1').complexityGauge();}
$('#id_new_password2').matchTest({compareInputControl:$('#id_new_password1'),msgAfterSelector:'label[for="id_new_password2"]'});},handleTzChange:function(event){var self=this;this.model.save({timezone:this.tzoneDropDown.val()},{success:function(){self.tzoneDropDown.displayInlineMessage(lockifyGlobals.savedMsg);},error:function(){self.tzoneDropDown.displayInlineMessage('Something went wrong. Please try again.');}});},handleEmailLeakClose:function(){$('#emailLeakDialog').dialog('close');$('html').css('overflow-y','scroll');},handleEmailLeakOpen:function(){$("#emailLeakDialog").dialog(dialogOptions);$("button").blur();$('html').css('overflow-y','hidden');}});