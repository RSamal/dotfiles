var AccountLinkDetailsView=Backbone.View.extend({events:{'click #loadLinkHistory':'showLinkHistory','click #hideLinkHistory':'hideLinkHistory'},initialize:function(options){this.options=$.extend({},this.defaults,options);this.options.grid.on('detailsRowClick',_.bind(this.switchState,this));this.publicId=this.model.get('publicId');this.timezone=this.options.commonModel.get('timezone');this.listenTo(this.model,"changed:nickname",_.bind(this.loadLinkHistoryIf,this));this.listenTo(this.model,"changed:receiveNotifications",_.bind(this.loadLinkHistoryIf,this));this.listenTo(this.model,"change:activeStatus",_.bind(this.loadLinkHistoryIf,this));_.bindAll(this,'render','getLinkContentsStatus','getDetailsBody','loadLinkHistory');},getLinkContentsStatus:function(){var metaData=this.model.get('metaData');var charCount=metaData.messageLength;var fileCount=0;var filesInfo='';if(metaData.files){fileCount=metaData.files.length;filesInfo='<ol class="'+((fileCount>1)?'mult':'single')+'">';filesInfoList=$.map(metaData.files,function(file){var filename=file.filename;var numBytes=lockifyUtils.formatFileSize(file.numBytes);var fileSaved=file.saved?'<span class="icon-disk icomoon-icon" aria-hidden="true" title="File saved by recipient."></span>':'<span class="icon-blocked icomoon-icon" aria-hidden="true" title="File not saved by recipient."></span>';return'<li><span class="fileName">'+filename+'</span>'+'<span class="fileSize">'+numBytes+'</span>'+'<span class="fileSaved">'+fileSaved+'</span></li>';}).join('\n');if(filesInfoList.indexOf("Name_Unknown")>=0){filesInfo='<div class="smallFont">File names hidden from server</div>';}else{filesInfo+=filesInfoList+'</ol>';}}
var msgStr;if(charCount){if(charCount<0){msgStr="Message";}else{msgStr=charCount+" character message";}
if(fileCount){msgStr+=' &amp; '+fileCount+((fileCount==1)?' file:':' files:');}else{msgStr+=' &amp; no files';}}else{msgStr='No message &amp; '+fileCount+((fileCount==1)?' file:':' files:');}
return msgStr+filesInfo;},getDetailsBody:function(){var basicLinkDetails;var remainVals='<span class="wideOnly">Remaining: '+this.model.get('remainingViews')+" of "+this.model.get('maxViews')+((this.model.get('remainingViews')>1)?' viewings':' viewing')+" &amp; "+this.model.get('remainingMinutes')+" of "+this.model.get('lifeMinutes')+'</span>'+'<span class="narrowOnly">'+this.model.get('remainingViews')+" / "+this.model.get('maxViews')+((this.model.get('remainingViews')>1)?' views':' view')+" &amp; "+this.model.get('remainingMinutesShort')+" / "+this.model.get('lifeMinutes')+' left</span>';if(this.model.get('activeStatus')=="LIVE"){basicLinkDetails='<div class="linkRemaining">'+remainVals+'</div>';}else{basicLinkDetails='<div class="linkRemaining defaultHide">'+remainVals+'</div>';}
var notifyText;if(this.model.get('activeStatus')=="LIVE"){notifyText=this.model.get('receiveNotifications')?'<span class="link">On</span>':'<span class="link">Off</span>';}else{notifyText=this.model.get('receiveNotifications')?'On':'Off';}
basicLinkDetails+='<div class="notifyRow"><span class="notificationsLink rlb">Notifications: '+notifyText+'</span></div>';var bitStrength=this.model.get('bitStrength');basicLinkDetails+="Key: "+bitStrength+" bit";var useridsServer=this.model.get('useridsServer')||[];var authenticationType=this.model.get('authenticationType');var securityAnswersCount=this.model.get('securityAnswersCount');var acceptsCloseAnswers=this.model.get('acceptsCloseAnswers');var idCount=useridsServer.length;var authdetails;switch(authenticationType){case'password':authdetails='A password you shared with them';break;case'question':authdetails='A question you posed to them:<br/>'+securityAnswersCount+' acceptable answer'+(securityAnswersCount==1?'':'s')+' and &quot;close&quot; answers are '+(acceptsCloseAnswers?'':'not ')+'allowed';break;case'twitter':authdetails=(idCount==1?"Their Twitter username matching:":"Their Twitter username matching one of the following:")+'<br/>'+useridsServer.join("<br/>");break;case'email':authdetails=(idCount==1?"Their email address matching:":"Their email address matching one of the following:")+'<br/>'+useridsServer.join("<br/>");break;case'gmail':authdetails=(idCount==1?"Their email address matching:":"Their email address matching one of the following:")+'<br/>'+useridsServer.join("<br/>");break;case'native':authdetails='Their Lockify account matching:<br/>'+useridsServer.join('<br/>');break;case'phone':var _formatpn=function(){return $.map(useridsServer,function(id){try{return id.slice(1,4)+'-'+id.slice(4,7)+'-'+id.slice(7,11);}catch(e){return"";}}).join('<br/>');};authdetails=(idCount==1?"Their phone # matching:":"Their phone # matching one of the following:")+'<br/>'+_formatpn();break;default:authdetails='Recipient only needs to have the Link';}
if(typeof debug!='undefined'&&debug=='True'){basicLinkDetails+="<div class='header'>Recipient Identity Verification<sup>&dagger;</sup></div> "+"<div class='detailRow authDetails'>"+authdetails+"</div>";basicLinkDetails+="<div class='header'>Recipient can easily<sup>&dagger;</sup>:</div>"+"<div class='optionExpire'>"+"<input type='checkbox' class='allowExpire' name='allowExpire' disabled='disabled'> "+"<label for='allowExpire' class='disabled'>"+"<span aria-hidden='true' class='icon-link-expired icomoon-icon small'></span>  "+"Early-expire Link</span></div>";basicLinkDetails+="<div class='optionDecryptWithWebApp'>"+"<input type='checkbox' class='allowDecryptWithWebApp' name='allowDecryptWithWebApp' disabled='disabled'> "+"<label for='allowDecryptWithWebApp' class='disabled'>"+"<span aria-hidden='true' class='icon-link-expired icomoon-icon small'></span>  "+"Access Link using Lockify web app</span></div>";}
if(typeof this.publicId!='undefined'&&lockify.pagePrefs&&lockify.pagePrefs.enable_events=="True"){basicLinkDetails+="<div id='loadLinkHistory' class='link'>"+"<span class='icon-plus icomoon-icon small' aria-hidden='true'></span> "+"Show Detailed Link History</div>"+"<div id='hideLinkHistory' class='link defaultHide'>"+"<span class='icon-minus icomoon-icon small' aria-hidden='true'></span> "+"Hide Detailed Link History</div>"+"<div class='blockLinkHistory defaultHide'></div>";}
return basicLinkDetails;},switchState:function(){var model=arguments[0][0];if(this.publicId!=model.get('publicId')){return;}
if(this.$el.is(':visible')){this.$el.siblings('.linkContent').addClass('short').html(this.model.get('contentsStatus'));this.$el.siblings('.linkLimits').hide();this.$el.hide();}
else{this.$el.siblings('.linkContent').removeClass('short').html(this.getLinkContentsStatus());this.$el.siblings('.linkLimits').show();this.$el.html(this.getDetailsBody());this.$el.find('.allowExpire').prop('checked',this.model.get('allowManualExpiration'));this.$el.find('.allowDecryptWithWebApp').prop('checked',this.model.get('decryptClientTypes'));this.$el.show();this.renderQtips();}},renderQtips:function(){var elem=$('.fileSaved .icomoon-icon');lockifyUtils.setupQtips(elem,{my:'bottom center',at:'top center'},{corner:'bottom center'},{text:elem.attr('title')});},hideLinkHistory:function(){this.$('#loadLinkHistory').removeClass('defaultHide');this.$('#hideLinkHistory').addClass('defaultHide');this.$('.blockLinkHistory').slideUp();},showLinkHistory:function(){this.$('#loadLinkHistory').addClass('defaultHide');this.$('#hideLinkHistory').removeClass('defaultHide');if(this.$('.blockLinkHistory').text().length){this.$('.blockLinkHistory').slideDown();return;}
this.$('.blockLinkHistory').html($('.linksGridLoad').clone());this.$('.blockLinkHistory').find('.linksGridLoad').show();this.$('.blockLinkHistory').slideDown();this.loadLinkHistory();},loadLinkHistoryIf:function(){if($('.blockLinkHistory').is(':visible')){this.loadLinkHistory();}},loadLinkHistory:function(){var view=this;lockifyAjax.ajaxJSONSafe('/account/link/'+this.publicId+'/events/',"timezone="+this.timezone,function(data){if(!data.success){return;}
var eventHtml="<table class='historyTable' cellspacing='0' cellpadding='0'>"+"<thead><tr><th class='when renderable'>When</th><th class='what renderable'>What</th><th class='ip renderable'>IP</th></tr>"+"</thead><tbody>";$.each(data.events,function(index,event){eventHtml+="<tr>";eventHtml+="<td class='when renderable'>"+event.happened_when+"</td>";eventHtml+="<td class='what renderable'>"+event.event_type;if(event.event_type=="Decrypted file downloaded"){var cust_attr=JSON.parse(event.custom_attributes);if("File Index"in cust_attr){eventHtml+=" ("+(Number(cust_attr["File Index"])+1);if("Total File Count"in cust_attr){eventHtml+=" of "+cust_attr["Total File Count"];}
eventHtml+=")";}}
eventHtml+="</td>";eventHtml+="<td class='ip renderable'>"+((event.ipv4===null)?'':event.ipv4)+"</td>";eventHtml+="</tr>";});eventHtml+="</tbody></table>";view.$('.blockLinkHistory').html(eventHtml);},null);}});