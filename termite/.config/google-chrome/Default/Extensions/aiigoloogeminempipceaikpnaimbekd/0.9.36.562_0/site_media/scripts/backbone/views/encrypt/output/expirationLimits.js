var OutputExpirationLimitsView=BaseEncryptOutputView.extend({defaults:{remainingViews:0,remainingTime:"0 mins"},events:{"mosueenter #btnAdminDelete":"handleMouseenter","mosueleave #btnAdminDelete":"handleMouseleave","click #expireLimitsRefresh":"handleRefreshClick"},initialize:function(options){this.options=$.extend({},this.defaults,options);OutputExpirationLimitsView.__super__.initialize();lockifyUtils.setupQtips('#expireLimitsRefresh');$('#remainingViewsVal').text(this.options.remainingViews);$('#remainingViewsVal').next('span').pluralize({'value':this.options.remainingViews});$('#remainingTimeDesc').html(lockifyUtils.splitValueIntoSpans(this.options.remainingTime));$("#btnAdminDelete").click(function(){$("#expireLinkDialog").dialog(dialogOptions);$("#btnAdminDelete").bind('keyup','return',function(){$("#btnAdminDelete").click();});$("#btnExpireLinkNow").blur();});_.bindAll(this,'handleExpireClick','handleLinkExpiration','handleRefreshSuccess');$('body').find('#btnExpireLinkNow').click(this.handleExpireClick);$(document).bind('linkExpired',this.handleLinkExpiration);},handleMouseenter:function(){$("#expireButtonIcon").addClass("expireButtonIcon-hover");},handleMouseleave:function(){$("#expireButtonIcon").removeClass("expireButtonIcon-hover");},handleExpireClick:function(){var deleteQueryString="d="+this.model.get('dataHash')+"&ap="+this.model.get('cryptoAssets').adminCredHash;var pickedFields=_.pick(this.model.attributes,'dataHash','publicId');pickedFields.adminCredHash=this.model.get("cryptoAssets")["adminCredHash"];pickedFields.expire=true;this.model.url="/entry/patch_express";this.model.save(pickedFields,{patch:true,success:this.updateUiAfterExpiration,error:function(model,req,textStatus,errorThrown){$("#divAdminInfo").append(req.responseText).show();}});},handleRefreshClick:function(event){this.model.set({'currentExpirationLimits':new EntryCurrentExpirationLimitsModel()});this.model.get('currentExpirationLimits').fetch({data:{dh:this.model.get('dataHash')},type:'POST',success:this.handleRefreshSuccess});$("#valuesContainer").removeClass('hover').addClass('refresh');$("#expireLimitsRefresh").removeClass('hover').qtip('hide');setTimeout(function(){$("#valuesContainer").removeClass('refresh');},1000);},handleLinkExpiration:function(){if($("#expireLinkDialog.ui-dialog-content").length&&$("#expireLinkDialog").dialog("isOpen")===true){$("#expireLinkDialog").dialog('close');}
$("#btnAdminDelete").prop('disabled',true);$(this.el).hide();$("#btnAdminDelete").hide();$("#expireLinkDialog").bind('dialogclose',function(event){$("#successExpireDialog").dialog($.extend({},dialogOptions,{modal:false,dialogClass:'blip'}));setTimeout(function(){$("#successExpireDialog").dialog('close');$("#expireLinkDialog").unbind('dialogclose');},2500);});},handleRefreshSuccess:function(model,json){this.model.get('currentExpirationLimits').set({'isExpired':json.is_expired,'remainingViews':json.remaining_views,'remainingTime':json.remaining_time,'dateTime':json.dateTime,'expirationReasonCode':json.expiration_reason_code});if(json.is_expired||json.remaining_views===0||json.remaining_time===""){json.success=true;this.updateUiAfterExpiration(json);}
else{$('#remainingViewsVal').text(json.remaining_views);$('#remainingViewsVal').next('span').pluralize({'value':json.remaining_views});$('#remainingTimeDesc').html(lockifyUtils.splitValueIntoSpans(json.remaining_time));$('#remainingViewsContainer').show();}},updateUiAfterExpiration:function(json){if(json.success||(!json.success&&json.expiration_reason_code!=='')){$(document).trigger('linkExpired',json);$('#commonLinkSettings').find('.sectionSeparator').hide();}
else{$("#expireLinkDialog").dialog('close');alert("Expiration Failed: "+json.Reason);}}});