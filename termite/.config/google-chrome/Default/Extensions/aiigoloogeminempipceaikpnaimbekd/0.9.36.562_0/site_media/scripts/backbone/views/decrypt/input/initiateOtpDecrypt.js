var InitiateOtpDecryptView=BaseDecryptInputView.extend({initialize:function(options){this.options=$.extend({},this.defaults,options);},setChannel:function(channel){this.options={channel:channel};return this;},formatUSPhone:function(){throw"This function has not been overridden by its child instance.";},updateVoiceStatus:function(){throw"This function has not been overridden by its child instance.";},showOtpError:function(){throw"This function has not been overridden by its child instance.";},initiateOtp:function(){var recipient="";if(this.options.channel=='email'){this.options.recipient=$('input#email').val();}else{if(!$('input#phone_number').hasValidLength()){$('#multiFactorInitiate').find('span.error').text('Enter a valid # in form 555-555-5555.').show();}else if(!$('input.phone_number').hasValidAreaCode()){$('#multiFactorInitiate').find('span.error').text('Please enter a phone number with a valid area code.').show();}
this.options.recipient=$('input.phone_number').phoneNumberVal();}
this.options.recipientHash=lockifyCryptoUtils.hash_sha256_b64u(lockify.gateway.salt+this.options.recipient.toLowerCase());this.approveUserId(this.options.recipientHash,this.userIdHashCheckSuccess);},approveUserId:function(recipient,success){lockifyAjax.ajaxJSONSafe('/otp/send/','channel='+encodeURIComponent(this.options.channel)+'&recipient='+recipient+'&dh='+encodeURIComponent(lockify.gateway.dataHash),_.bind(success,this));},userIdHashCheckSuccess:function(response){if(response.status=='approved'){this.approveUserId(encodeURIComponent(this.options.recipient),_.bind(this.userIdPlainCheckSuccess,this));}else{if(typeof response.message!='undefined'){var swapString=this.options.recipient;if(this.options.channel=='sms'||this.options.channel=='voice'){swapString=this.formatUSPhone(this.options.recipient);}
this.showOtpError(response.message.replace(this.options.recipientHash,swapString));}
$('.codeInputContainer input[type=text]').focus();}},userIdPlainCheckSuccess:function(response){if(response.status=='sent'){$('.error').hide();$('.authUI_desc').hide();$('.topBannerInstruction').text('');$('#getSecret').hide();if(this.options.channel=='email'){$('#authMultiFactorSessionEmail').val(response.session);$('#multiFactorInitiateEmail').hide();$('#multiFactorCode_email').show();$('#methodMetaTips').hide();$('#notYoursButtons').show();if(lockifyGlobals.enableIntEmail){$('#back_email_button').show();}
$('#emailSent').show();$('#emailAuthMultiFactorCode').focus();$('#emailHeader-action').show();$('#openidHeader').hide();$('#nativeHeader').hide();$('#emailHeader').hide();}else if(this.options.channel=='sms'||this.options.channel=='voice'){$('#authMultiFactorSession').val(response.session);$('#multiFactorInitiate').hide();$('#multiFactorCode').show();$('#back_phone_button').show();$('#methodMetaTips').hide();$('.otpRecipient').text(this.formatUSPhone($('#phone_number').phoneNumberVal()));if(this.options.channel=='sms'){$('#notYoursButtons').show();$('#smsCodeInputContainer').show();$('#smsMessageSent').show();$('#smsAuthMultiFactorCode').focus();$('#phoneHeader-voiceAction').hide();$('#phoneHeader-textAction').show();$('#phoneHeader').hide();$('#smsAuthMultiFactorCode').keyfilter(/[0-9]/).bind('filtered',function(){$(this).addClass('validationError')});}else{$('#notYoursButtons').show();$('#otpVoiceStatus').children().removeClass('complete_voice_status').addClass('pending_voice_status');$('#otpVoiceStatus_leaving_voicemail').hide();$('#otpVoiceStatus_in_progress').show();$('#smsCodeInputContainer').hide();this.updateVoiceStatus(response.session,'calling',120);$('#voiceCallSent').show();$('#voiceAuthMultiFactorCode').focus();$('#phoneHeader-voiceAction').show();$('#phoneHeader-textAction').hide();$('#phoneHeader').hide();$('#voiceAuthMultiFactorCode').keyfilter(/[0-9]/).bind('filtered',function(){$(this).addClass('validationError')});}}}else if(response.status=='deleted'){lockifyUtils.showDeletedMessage(response);$('#expiredMessage p:first').show();return;}else if(response.status=='locked'){$("#onHoldDiv").show();$("#page").removeClass("withSidebar");$("#validDiv").hide();$("#onHoldDiv").find("#deletedItem").text(json.serverStoredAsset=="ciphertext"?"encrypted data":"decryption key");return;}else{if(typeof response.message!='undefined'){this.showOtpError(response.message);}
$('.codeInputContainer input[type=text]').focus();}
this.trigger('otpRequestComplete');},handleFocus:function(){},handleBlur:function(){},handleLinkClick:function(){$('.otpSent').hide();$('#multiFactorInitiate').show();$('.authUI_desc').show();$('#multiFactorCode').hide();$('#smsAuthMultiFactorCode, #voiceAuthMultiFactorCode').val('');$('#getSecret').hide();$('#authUi_phoneNumber').find('.error').hide();$('.noContactLink').show();$('.noContactLink').next('span').hide();$('#phoneHeader-textAction').hide();$('#phoneHeader-voiceAction').hide();$('#phoneHeader').show();$('#phoneMetaTips').show();$('#back_phone_button').hide();$('#methodMetaTips').show();return false;}});