var AuthPhoneDecryptView=InitiateOtpDecryptView.extend({events:{"focus .phone_number":"handleFocus","focus #smsAuthMultiFactorCode":"handleSmsVoiceFocus","focus #voiceAuthMultiFactorCode":"handleSmsVoiceFocus","blur .phone_number":"handleBlur","blur #smsAuthMultiFactorCode":"handleSmsVoiceBlur","blur #voiceAuthMultiFactorCode":"handleSmsVoiceBlur","keyup #voiceAuthMultiFactorCode":"handleOtpKeyup","input #voiceAuthMultiFactorCode":"handleOtpKeyup","keyup #smsAuthMultiFactorCode":"handleOtpKeyup","input #smsAuthMultiFactorCode":"handleOtpKeyup","keyup .phone_number":"handleInputKeyup","click .noContactLink":"handleNoContactClick","click #smsButton":"handleSmsClick","click #voiceButton":"handleVoiceClick","click .send_again":"handleLinkClick","click #phoneBackButton":"handleLinkClick"},initialize:function(options){this.options=$.extend({},this.defaults,options);$('#notYoursButtons').hide();$('#authUi_phoneNumber').show();$('#phoneHeader').show();$('#phoneMetaTips').show();AuthPhoneDecryptView.__super__.finishInstructionText(this.options.json,this.options.auth_infoKey,$('#validPhoneNums'));$('#phone_number').keyfilter(/[\d\-\.]/).bind('filtered',function(){$(this).addClass('validationError');});$('#validPhoneNums').find('.value').each(function(i,elem){$(elem).css({'word-spacing':'0.5ex'});});if($('#validPhoneNums').children().hasClass('multipleValueIds')){$('#maskMismatch .one').hide();$('#maskMismatch .multiple').show();$('.status .multiple').show();$('.status .single').hide();}else{$('.status .multiple').hide();$('.status .single').show();}
$('#authUis').addClass('auth_type_phone');if(this.options.json.userids_aes256){$('#phone_number').data('masks',lockify.sjclBridge.decrypt.decrypts(this.options.json.userids_aes256,this.options.auth_infoKey));}
_.bindAll(this,['updateVoiceStatus']);AuthPhoneDecryptView.__super__.formatUSPhone=this.formatUSPhone;AuthPhoneDecryptView.__super__.updateVoiceStatus=this.updateVoiceStatus;AuthPhoneDecryptView.__super__.showOtpError=this.showOtpError;},handleFocus:function(){$('.phone_number').prev(".icon-phone").addClass("focus");},handleblur:function(){$('.phone_number').prev(".icon-phone").removeClass("focus");},handleInputKeyup:function(e){var el=$(e.currentTarget);var hideButtons=function(){$('#otp_buttons').hide();$('#phoneInputError').hide();$('#phone_number').removeClass('wrongPhone');};if(el.hasValidLength()&&el.hasValidAreaCode()){if(lockifyUtils.matchesMask(el.val(),el.data('masks').split(','))){$('span.target_number').text(this.formatUSPhone(el.phoneNumberVal()));$('#otp_buttons').show();$('#maskMismatch').hide();$(el).removeClass('validationError');$('#phone_number').bind('keydown',this.handleInputKeydown);}else{$('#maskMismatch').show();$(el).addClass('validationError');hideButtons();$('#phone_number').bind('keydown',this.handleInputKeydown);}}else{$('#maskMismatch').hide();$(el).removeClass('validationError');hideButtons();}},handleInputKeydown:function(e){if(typeof e!='undefined'&&(e.which==8||e.which<0x20||(e.which>=35&&e.which<=40))){$('#phone_number').unbind('keydown',this.handleInputKeydown);return true;}else{e.preventDefault();}
if(e.keyCode==13){return false;}},handleOtpKeyup:function(e){var el=$(e.currentTarget);if(el.val().length==$('#smsAuthMultiFactorCode').data('maxlength')){$('#getSecret').prop('disabled',false).removeClass('disabled');}else{$('.error').hide();$('#getSecret').prop('disabled',true).addClass('disabled');}
$(el).removeClass('validationError');},handleSmsClick:function(){$('#getSecret').insertAfter($('#smsAuthMultiFactorCode')).addClass('disabled').prop('disabled',true);var key=AuthPhoneDecryptView.__super__.setChannel('sms').initiateOtp();return false;},handleVoiceClick:function(){$('#getSecret').insertAfter($('#voiceAuthMultiFactorCode')).addClass('disabled').prop('disabled',true);var key=AuthPhoneDecryptView.__super__.setChannel('voice').initiateOtp();return false;},handleLinkClick:function(){AuthPhoneDecryptView.__super__.handleLinkClick();},handleSmsVoiceFocus:function(){AuthPhoneDecryptView.__super__.handleFocus();},handleSmsVoiceBlur:function(){AuthPhoneDecryptView.__super__.handleBlur();},handleNoContactClick:function(e){var el=$(e.currentTarget);el.next('span').toggle();el.hide();},updateVoiceStatus:function(key,status,ttl){this.setVoiceStatus(status);if(status=='complete'){ttl=-1;}
var self=this;lockifyAjax.ajaxJSONSafe('/otp/voice_status/','session='+key,function(call_status){if(ttl>=0){setTimeout(function(){self.updateVoiceStatus(key,call_status.status,ttl-1);},1000);}});},setVoiceStatus:function(status){var script=['verifying','otp_creation','calling',['answered','leaving_message'],'complete'];if(status=='leaving_message'){$('#otpVoiceStatus_in_progress').hide();$('#otpVoiceStatus_leaving_voicemail').removeClass('pending_voice_status').addClass('complete_voice_status').show();$('#otpVoiceStatus_leaving_voicemail').children('.icomoon-icon').addClass('icon-checkmark');}
if(status=='answered'){$('#otpVoiceStatus_in_progress').removeClass('pending_voice_status').addClass('complete_voice_status').show();$('#otpVoiceStatus_leaving_voicemail').hide();$('#otpVoiceStatus_in_progress').children('.icomoon-icon').addClass('icon-checkmark');}
$.each(script,function(index,s){if(!$.isArray(s)){if(!$('#otpVoiceStatus_'+s).hasClass('complete_voice_status')){$('#otpVoiceStatus_'+s).removeClass('pending_voice_status').addClass('complete_voice_status');$('#otpVoiceStatus_'+s).children('.icomoon-icon').addClass('icon-checkmark');}}
if(($.isArray(s)&&$.inArray(status,s)>=0)||s==status){return false;}});},formatUSPhone:function(num){if(num.length!=11){return num;}
return num.slice(1,4)+'-'+num.slice(4,7)+'-'+num.slice(7,11);},showOtpError:function(message){$('#phoneInputError').html(new Showdown.converter().makeHtml(message)).show();$('#phone_number').addClass('validationError').focus();$('#otp_buttons').hide();}});