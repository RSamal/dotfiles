(function(root,factory,undef){'use strict';if(typeof exports==='object'&&typeof require==='function'){module.exports=factory(require('underscore'),require('Backbone'));}else if(typeof define==='function'&&define.amd){define(['underscore','backbone'],function(_,Backbone){_=_===undef?root._:_;Backbone=Backbone===undef?root.Backbone:Backbone;return(root.returnExportsGlobal=factory(_,Backbone,root));});}else{root.returnExportsGlobal=factory(root._,root.Backbone);}}(this,function(_,Backbone,root,undef){'use strict';Backbone=Backbone===undef?root.Backbone:Backbone;_=_===undef?root._:_;var Mutator=function(){},oldGet=Backbone.Model.prototype.get,oldSet=Backbone.Model.prototype.set,oldToJson=Backbone.Model.prototype.toJSON;Mutator.prototype.mutators={};Mutator.prototype.get=function(attr){var isMutator=this.mutators!==undef;if(isMutator===true&&_.isFunction(this.mutators[attr])===true){return this.mutators[attr].call(this);}
if(isMutator===true&&_.isObject(this.mutators[attr])===true&&_.isFunction(this.mutators[attr].get)===true){return this.mutators[attr].get.call(this);}
return oldGet.call(this,attr);};Mutator.prototype.set=function(key,value,options){var isMutator=this.mutators!==undef,ret=null,attrs=null;ret=oldSet.call(this,key,value,options);if(_.isObject(key)||key===null){attrs=key;options=value;}else{attrs={};attrs[key]=value;}
if(isMutator===true&&_.isObject(this.mutators[key])===true){if(_.isFunction(this.mutators[key].set)===true){ret=this.mutators[key].set.call(this,key,attrs[key],options,_.bind(oldSet,this));}else if(_.isFunction(this.mutators[key])){ret=this.mutators[key].call(this,key,attrs[key],options,_.bind(oldSet,this));}}
if(isMutator===true&&_.isObject(attrs)){_.each(attrs,_.bind(function(attr,attrKey){if(_.isObject(this.mutators[attrKey])===true){var meth=this.mutators[attrKey];if(_.isFunction(meth.set)){meth=meth.set;}
if(_.isFunction(meth)){if(options===undef||(_.isObject(options)===true&&options.silent!==true&&(options.mutators!==undef&&options.mutators.silent!==true))){this.trigger('mutators:set:'+attrKey);}
meth.call(this,attrKey,attr,options,_.bind(oldSet,this));}}},this));}
return ret;};Mutator.prototype.toJSON=function(){var attr=oldToJson.call(this);_.each(this.mutators,_.bind(function(mutator,name){if(_.isObject(this.mutators[name])===true&&_.isFunction(this.mutators[name].get)){attr[name]=_.bind(this.mutators[name].get,this)();}else{attr[name]=_.bind(this.mutators[name],this)();}},this));return attr;};Mutator.prototype.escape=function(attr){var val=this.get(attr);return _.escape(val==null?'':''+val);};_.extend(Backbone.Model.prototype,Mutator.prototype);Backbone.Mutators=Mutator;return Mutator;}));