var LoginFormView=Backbone.View.extend({defaults:{bindSubmitEvent:true,loginJsonPath:"/accounts/login_json/"},events:{"click .installApp":"handleInlineAppInstall","click .otpSubmit":"handleLoginFormSubmit","keyup #id_otpresponse":"handleCodeKeyup"},initialize:function(options){this.options=$.extend({},this.defaults,options||{});$('#loginButton').waitButton({disableButton:false});this.$('.toggleMaskIcon').toggleMask({"inputs":$('#id_password')});_.bindAll(this,['handleLoginFormSubmit']);_.bindAll(this,['submitLoginForm']);if(this.options.bindSubmitEvent){$("#loginButton").click(this.submitLoginForm);$('#login_form #id_password').bind('keyup','return',this.submitLoginForm);}
_.bindAll(this,['reenableLoginButton']);$("#login_form").bind('submit',this.handleLoginFormSubmit);window.onload=function(){$('#id_username').focus();};_.bindAll(this,['handleUserAuth']);$(document).bind('userAuthComplete',this.handleUserAuth);},handleUserAuth:function(event,isAuthenticated,use_chrome_ext,json){var defaultEmailLabel=$('#emailInputLabel').data('default-text');var gappEmailLabel=$('#emailInputLabel').data('gapp-text');if(json.orgName!=null){$('#emailInputLabel').html(gappEmailLabel);$(document).find('.orgName').text(json.orgName);$(document).find('.orgWelcome').removeClass('defaultHide');$('.loginPassword').hide();$('#loginExtraInfo').remove();$('.showRegisterPanel').hide();$('#loginButton').text('Continue');$('#id_password').prop('disabled',true);this.options.loginJsonPath="/accounts/login_oauth_json/";}else{$('#emailInputLabel').text(defaultEmailLabel);}},handleLoginFormSubmit:function(){var login_form=$('#login_form');login_form.find('.error:not(.form_errors)').hide();login_form.find('input').removeClass('validationError');var self=this;if(window.location.hash=="#sign_in"){window.location.hash="";}
lockifyAjax.ajaxJSONSafeForm(this.options.loginJsonPath,login_form,function(json){if(json.oauthRedirectUrl){window.location=json.oauthRedirectUrl;}
if(json.twoFactorRequired){$('#firstLoginScreen').addClass('defaultHide');$('#secondLoginScreen').removeClass('defaultHide');$('#loginExtraInfo').addClass('defaultHide').hide();$('.dynamicText').text($('.dynamicText').data('twofa'));return;}
if(lockifyUtils.onNewLinkPage()){self.reenableLoginButton();}
lockify.account.userInfo.set(json);lockify.account.handleCreatorAuth(lockify.account.userInfo,json);},function(json){self.reenableLoginButton();$.each((json&&json.field_errors)||[],function(name,val){val=new Showdown.converter().makeHtml(val.join(' '));$('#'+name+"_errors").html(val).show();if($('#id_'+name).hasClass('toggleMaskInput')){$('#id_'+name).parent().addClass('validationError');}else{$('#id_'+name).addClass('validationError');}});});return false;},submitLoginForm:function(){if(this.options.bindSubmitEvent){$("#loginButton").unbind('click',this.submitLoginForm);$('#login_form #id_password').unbind('keyup','return',this.submitLoginForm);}
$('#login_form').trigger('submit');},reenableLoginButton:function(){$('#loginButton').trigger('deanimate');if(this.options.bindSubmitEvent){$("#loginButton").bind('click',this.submitLoginForm);$('#login_form #id_password').bind('keyup','return',this.submitLoginForm);}},handleInlineAppInstall:function(){chrome.webstore.install($('link#app-link').attr('href'),function(){},function(msg){Exception.handle("Couldn't install chrome app from chrome page.",document.location.href,0,true);$("#appFailInstall").dialog(dialogOptions);$("#appFailInstall span.errorDetails").text(msg);});},handleCodeKeyup:function(e){var el=$(e.currentTarget);if(el.val().length==el.data('maxlength')){$('#otpsubmit').prop('disabled',false).removeClass('disabled');}else{$('.error').hide();$('#otpsubmit').prop('disabled',true).addClass('disabled');}
$(el).removeClass('validationError');},});