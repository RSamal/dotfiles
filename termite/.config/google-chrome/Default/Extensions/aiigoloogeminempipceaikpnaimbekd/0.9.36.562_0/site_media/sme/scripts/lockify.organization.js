function fixedHeader(){$('thead').clone().appendTo('#thead-copy table');var move=function(){var st=$(window).scrollTop()+$('#fixedHeader').height();var ot=$("#thead-anchor").offset().top;var s=$("#thead-copy");var stp=$('#fixedHeader').height();if(st>ot){s.css({position:"fixed",top:stp,"z-index":"9999"}).show();}else{if(st<=ot){s.css({position:"relative",top:""}).hide();}}};$(window).scroll(move);move();}
$(document).ready(function(){$('.tabLink').click(function(){$('#tableLoading').removeClass('defaultHide');$('#backgridTables').addClass('defaultHide');$(this).addClass('active');$(this).siblings().removeClass('active');$('.tabBox').addClass('defaultHide');var tabBox=$(this).data('tabbox');$(tabBox).removeClass('defaultHide');});var hideLoading=function(){$('#tableLoading').addClass('defaultHide');$('#backgridTables').removeClass('defaultHide');};var org_slug=(typeof chrome=='undefined'||typeof chrome.extension=='undefined'&&typeof document.ajax_domain=='undefined')?window.location.pathname.split('/').reverse()[0]:window.location.search.split('=').reverse()[0];var orgModel=new OrganizationModel({id:org_slug});var organizationView=new OrganizationView({el:$('body'),model:orgModel});var activities=new ActivityCollection();activities.url="/sme/organization_json/"+org_slug+"/activities/";var activityGridView=new ActivityGridView({el:$('#orgActivityGridContainer'),collection:activities,orgModel:orgModel});$('#activityTab').click(function(){window.location.hash='activities';activities.fetch().done(hideLoading);});var emailDialog,addMemberDialogClone,emailMemberDialogClone,suspendDialog,revokeMembershipDialog,revokeMembershipDialogClone;var members=new MemberCollection();members.url="/sme/organization_json/"+org_slug+"/members/";var memberGridView=new MemberGridView({el:$('#orgMemberGridContainer'),collection:members,orgModel:orgModel});$('#memberTab').click(function(){window.location.hash='members';members.fetch().done(hideLoading);});if(window.location.hash=='#activities'){$('#activityTab').click();}else{$('#memberTab').click();}
var memberFormView;var createMemberFormView=function(gridView,timezones,model){model=model||new MemberModel({'status':'not yet invited','role':'end-user','timezone':orgModel.get('organization').timezone});model.set('orgid',orgModel.get('id'));model.orgModel=orgModel;if(typeof memberFormView!='undefined'){memberFormView.remove();}
if($('#addMemberDialog').length){addMemberDialogClone=$('#addMemberDialog').clone();}else{$('#orgMemberGridContainer').prepend(addMemberDialogClone.clone());}
memberFormView=new MemberFormView({model:model,el:$('#addMemberDialog'),favoredTimezones:timezones,timezone:model.isNew()?orgModel.get('organization').timezone:model.get('timezone')});gridView.collection.listenTo(memberFormView,'memberAdded',function(memberModel){if(!this.contains(memberModel)){this.add(memberModel);}else{lockifyUtils.showMessageDialog('Member successfully edited');}
diag.dialog('close');});$('#addMemberDialog').bind('dialogclose',function(event){$(this).find('button').trigger('deanimate');});var diag=$('#addMemberDialog').dialog(dialogOptions);return memberFormView;};var emailFormView;var createEmailFormView=function(emailModel){if(typeof emailFormView!='undefined'){emailFormView.remove();}
if($('#emailMemberDialog').length){emailMemberDialogClone=$('#emailMemberDialog').clone();}else{$('#orgMemberGridContainer').prepend(emailMemberDialogClone.clone());}
emailFormView=new EmailFormView({model:emailModel,el:$('#emailMemberDialog')});emailFormView.render();$('#emailMemberDialog').bind('dialogclose',function(event){$(this).find('button').trigger('deanimate');});$(".toggleTrigger").off('click');$(".toggleTrigger").on('click',function(){lockifyUtils.handleToggle(this);});emailDialog=$('#emailMemberDialog').dialog(dialogOptions);lockifyUtils.setupQtips($('.link'));return emailFormView;};var suspendFormView;var getOrCreateSuspendFormView=function(model){if(typeof suspendFormView=='undefined'){suspendFormView=new Backbone.View({el:$('#suspendMembershipDialog')});}
suspendFormView.model=model;suspendFormView.render();suspendDialog=$('#suspendMembershipDialog').dialog(dialogOptions);return suspendFormView;};var revokeFormView;var createRevokeFormView=function(model){if(typeof revokeFormView!='undefined'){revokeFormView.remove();}
if($('#revokeMembershipDialog').length){revokeMembershipDialogClone=$('#revokeMembershipDialog').clone();}else{$('#orgMemberGridContainer').prepend(revokeMembershipDialogClone.clone());}
revokeFormView=new RevokeFormView({el:$('#revokeMembershipDialog'),model:model});revokeFormView.render();revokeMembershipDialog=$('#revokeMembershipDialog').dialog(dialogOptions);return revokeFormView;};memberGridView.on('addBtnClick',function(ev){var timezones=new FavoredTimezones();timezones.url="/sme/timezones/"+this.options.orgModel.get('id')+"/favored/";memberFormView=createMemberFormView(this,timezones);memberFormView.off('memberAdded',checkForInviteRequest);memberFormView.on('memberAdded',checkForInviteRequest);});memberGridView.on('editRowClick',function(event,model){var timezones=new FavoredTimezones();model=arguments[0][0];timezones.url="/sme/timezones/"+this.options.orgModel.get('id')+"/favored/"+model.get('id')+"/";createMemberFormView(this,timezones,model);});memberGridView.on('invokeRowClick',function(event,model){model=arguments[0][0];createMemberFormView(this,timezones,model);});var checkForInviteRequest=function(memberModel){if($.map(memberModel.changed,function(element,index){return index}).length>1){lockifyUtils.showMessageDialog('Existing user added as member.',10000);}
else if(memberModel.get('isInviteRequested')===true){handleInviteRequest(null,memberModel);}else{lockifyUtils.showMessageDialog('Member successfully added');}};var handleInviteRequest=function(event,userModel){var emailModel=new MemberEmailModel({id:'invite'});if(!(userModel instanceof MemberModel)){userModel=event[0];}
emailModel.orgModel=orgModel;emailModel.userModel=userModel;emailModel.off('inviteSaveSuccess');emailModel.on('inviteSaveSuccess',handleInviteSaveSuccess);emailModel.off('inviteSaveFailure');emailModel.on('inviteSaveFailure',handleInviteSaveFailure);emailModel.fetch().then(function(){createEmailFormView(emailModel);});};memberGridView.on('inviteRowClick',handleInviteRequest);var handleInviteSaveSuccess=function(){emailDialog.dialog('close');lockifyUtils.showMessageDialog('Invitation successfully sent');};var handleInviteSaveFailure=function(data){emailDialog.dialog('close');var msg='Sorry, there was a problem. Your email was not sent. ';try{msg=msg+data.message;}catch(x){}finally{lockifyUtils.showMessageDialog(msg,5000);}};var handleSuspendRequest=function(event){var model=arguments[0][0];getOrCreateSuspendFormView(model);};memberGridView.on('suspendRowClick',handleSuspendRequest);var handleSuspendSaveSuccess=function(){suspendMembershipDialog.dialog('close');lockifyUtils.showMessageDialog('Member successfully suspended');};var handleRevokeRequest=function(event){var userModel=event[0];var model=arguments[0][0];model.set('orgid',orgModel.get('id'));model.userModel=userModel;createRevokeFormView(model);model.on('destroy',handleRevokeSaveSuccess);};memberGridView.on('revokeRowClick',handleRevokeRequest);var handleRevokeSaveSuccess=function(){revokeMembershipDialog.dialog('close');lockifyUtils.showMessageDialog('Membership successfully revoked');orgModel.set('current_member_count',orgModel.get('current_member_count')-1)};});